{% extends "Master/Base/base.html" %}
{% block content %}
{% load static %}

<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'css/online_production_report.css' %}">

<!-- Popup Notification -->
<div id="popupMessage" class="popup-message hidden"></div>

<div class="form-container">
    <!-- Header with Status Field -->
    <div class="form-header">
        <h3 class="text-2xl font-bold italic" style="color: #1e3a8a;">
            {% if edit_mode %}Edit Production Status{% else %}Production Status Form{% endif %}
        </h3>
        
        <!-- Status Dropdown in Top Right Corner -->
        <div class="status-field-container">
            <label for="status">Status <span style="color: red;">*</span></label>
            <select name="status" id="status" required form="productionReportForm">
                <option value="in_progress" {% if edit_mode and report.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="completed" {% if edit_mode and report.status == 'completed' %}selected{% endif %}>Completed</option>
                <option value="on_hold" {% if edit_mode and report.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                <option value="cancelled" {% if edit_mode and report.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
    </div>

    <form id="productionReportForm" method="post">
        {% csrf_token %}
        {% if edit_mode %}
        <input type="hidden" name="report_id" value="{{ report.id }}">
        {% endif %}

        <!-- ============ GENERAL SECTION ============ -->
        <div class="section-heading">
            <h4>General Details</h4>
        </div>

        <!-- Production ID -->
        <div>
            <label for="production_id_display">Production ID <span class="auto-gen-label">(Auto-generated)</span> <span style="color: red;">*</span></label>
            <input type="text" id="production_id_display"
                value="{% if edit_mode %}{{ report.production_id }}{% else %}{{ next_production_id }}{% endif %}"
                readonly>
        </div>

        <!-- Date -->
        <div>
            <label for="date">Date <span style="color: red;">*</span></label>
            <input type="date" name="date" id="date" required
                value="{% if edit_mode %}{{ report.date|date:'Y-m-d' }}{% endif %}">
        </div>

        <!-- Date of Production -->
        <div>
            <label for="date_of_production">Date of Production <span style="color: red;">*</span></label>
            <input type="date" name="date_of_production" id="date_of_production" required
                value="{% if edit_mode and report.date_of_production %}{{ report.date_of_production|date:'Y-m-d' }}{% endif %}">
        </div>

        <!-- Die Requisition ID -->
        <div>
            <label for="die_requisition">Die Requisition ID <span style="color: red;">*</span></label>
            <select name="die_requisition" id="die_requisition" required>
                <option value="">Select Date of Production First</option>
                {% if edit_mode and report.die_requisition %}
                <option value="{{ report.die_requisition.id }}" selected>
                    {{ report.die_requisition.die_requisition_id }}
                </option>
                {% endif %}
            </select>
        </div>

        <!-- Die No -->
        <div>
            <label for="die_no">Die No</label>
            <input type="text" name="die_no" id="die_no"
                value="{% if edit_mode %}{{ report.die_no }}{% endif %}">
        </div>

        <!-- Section No -->
        <div>
            <label for="section_no">Section No</label>
            <input type="text" name="section_no" id="section_no"
                value="{% if edit_mode %}{{ report.section_no }}{% endif %}">
        </div>

        <!-- Section Name -->
        <div>
            <label for="section_name">Section Name</label>
            <input type="text" name="section_name" id="section_name"
                value="{% if edit_mode %}{{ report.section_name }}{% endif %}">
        </div>

        <!-- WT Per Piece -->
        <div>
            <label for="wt_per_piece_general">WT per Piece</label>
            <input type="number" step="0.01" name="wt_per_piece_general" id="wt_per_piece_general"
                value="{% if edit_mode and report.wt_per_piece_general %}{{ report.wt_per_piece_general }}{% endif %}">
        </div>

        <!-- No of Cavity -->
        <div>
            <label for="no_of_cavity">No of Cavity</label>
            <input type="text" name="no_of_cavity" id="no_of_cavity"
                value="{% if edit_mode %}{{ report.no_of_cavity }}{% endif %}">
        </div>

        <!-- Cut Length -->
        <div>
            <label for="cut_length">Cut Length</label>
            <input type="text" name="cut_length" id="cut_length"
                value="{% if edit_mode %}{{ report.cut_length }}{% endif %}">
        </div>

        <!-- Press -->
        <div>
            <label for="press">Press <span style="color: red;">*</span></label>
            <select name="press" id="press" required>
                <option value="">Select Press</option>
                {% for p in presses %}
                <option value="{{ p.id }}" {% if edit_mode and report.press.id == p.id %}selected{% endif %}>
                    {{ p.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Shift -->
        <div>
            <label for="shift">Shift</label>
            <select name="shift" id="shift">
                <option value="">Select Shift</option>
                {% for s in shifts %}
                <option value="{{ s.id }}" {% if edit_mode and report.shift and report.shift.id == s.id %}selected{% endif %}>
                    {{ s.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Operator -->
        <div>
            <label for="operator">Operator</label>
            <select name="operator" id="operator">
                <option value="">Select Operator</option>
                {% for st in staff %}
                <option value="{{ st.id }}" {% if edit_mode and report.operator and report.operator.id == st.id %}selected{% endif %}>
                    {{ st.first_name }} {{ st.last_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Planned QTY -->
        <div>
            <label for="planned_qty">Planned QTY</label>
            <input type="number" name="planned_qty" id="planned_qty" min="1"
                value="{% if edit_mode and report.planned_qty %}{{ report.planned_qty }}{% endif %}">
        </div>

        <!-- ============ PRODUCTION TIME DETAILS ============ -->
        <div class="section-heading">
            <h4>Production Time Details</h4>
        </div>

        <!-- Start Time -->
        <div>
            <label for="start_time">Start Time</label>
            <input type="time" name="start_time" id="start_time"
                value="{% if edit_mode and report.start_time %}{{ report.start_time|time:'H:i' }}{% endif %}">
        </div>

        <!-- End Time -->
        <div>
            <label for="end_time">End Time</label>
            <input type="time" name="end_time" id="end_time"
                value="{% if edit_mode and report.end_time %}{{ report.end_time|time:'H:i' }}{% endif %}">
        </div>

        <!-- ============ PRODUCTION INPUT DETAILS ============ -->
        <div class="section-heading">
            <h4>Production Input Details</h4>
        </div>

        <!-- Billet Size -->
        <div>
            <label for="billet_size">Billet Size (mm)</label>
            <input type="text" name="billet_size" id="billet_size"
                value="{% if edit_mode %}{{ report.billet_size }}{% endif %}">
        </div>

        <!-- No of Billet -->
        <div>
            <label for="no_of_billet">No of Billet</label>
            <input type="number" name="no_of_billet" id="no_of_billet" min="1"
                value="{% if edit_mode and report.no_of_billet %}{{ report.no_of_billet }}{% endif %}">
        </div>

        <!-- Weight -->
        <div>
            <label for="weight">Weight</label>
            <input type="number" step="0.01" name="weight" id="weight"
                value="{% if edit_mode and report.weight %}{{ report.weight }}{% endif %}">
        </div>

        <!-- Input -->
        <div>
            <label for="input_qty">Input</label>
            <input type="number" step="0.01" name="input_qty" id="input_qty"
                value="{% if edit_mode and report.input_qty %}{{ report.input_qty }}{% endif %}">
        </div>

        <!-- ============ PRODUCTION OUTPUT DETAILS ============ -->
        <div class="section-heading">
            <h4>Production Output Details</h4>
        </div>

        <!-- WT per Piece (Output) -->
        <div>
            <label for="wt_per_piece_output">WT per Piece</label>
            <input type="number" step="0.01" name="wt_per_piece_output" id="wt_per_piece_output"
                value="{% if edit_mode and report.wt_per_piece_output %}{{ report.wt_per_piece_output }}{% endif %}">
        </div>

        <!-- No of Pieces -->
        <div>
            <label for="no_of_pieces">No of Pieces</label>
            <input type="number" name="no_of_pieces" id="no_of_pieces" min="1"
                value="{% if edit_mode and report.no_of_pieces %}{{ report.no_of_pieces }}{% endif %}">
        </div>

        <!-- Total Output (Calculated) -->
        <div>
            <label for="total_output">Total Output <span class="auto-gen-label">(Auto-calculated)</span></label>
            <input type="text" id="total_output"
                value="{% if edit_mode and report.total_output %}{{ report.total_output }}{% endif %}"
                readonly>
        </div>

        <!-- Submit Button -->
        <button type="submit">
            {% if edit_mode %}Update Production Report{% else %}Save Production Report{% endif %}
        </button>
    </form>
</div>

<!-- Pass data to JavaScript -->
{% if edit_mode %}
<script>
    window.editMode = true;
    window.reportId = {{ report.id }};
</script>
{% else %}
<script>
    window.editMode = false;
</script>
{% endif %}

<!-- JavaScript -->
<script src="{% static 'js/online_production_report.js' %}"></script>

{% endblock %}