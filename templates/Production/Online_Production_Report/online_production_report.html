{% extends "Master/Base/base.html" %}
{% block content %}
{% load static %}

<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'css/online_production_report.css' %}">

<!-- Popup Notification -->
<div id="popupMessage" class="popup-message hidden"></div>

<div class="form-container">
    <!-- Header with Status Field -->
    <div class="form-header">
        <h3 class="text-2xl font-bold italic" style="color: #1e3a8a;">
            {% if edit_mode %}Edit Production Status{% else %}Production Status Form{% endif %}
        </h3>
        
        <!-- Status Dropdown in Top Right Corner -->
        <div class="status-field-container">
            <label for="status">Status <span style="color: red;">*</span></label>
            <select name="status" id="status" required form="productionReportForm">
                <option value="in_progress" {% if edit_mode and report.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="completed" {% if edit_mode and report.status == 'completed' %}selected{% endif %}>Completed</option>
                <option value="on_hold" {% if edit_mode and report.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                <option value="cancelled" {% if edit_mode and report.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
    </div>

    <form id="productionReportForm" method="post"
        action="{% if edit_mode %}{% url 'online_production_report_edit' report.id %}{% else %}{% url 'online_production_report' %}{% endif %}">
        {% csrf_token %}

        {% if edit_mode %}
        <input type="hidden" name="report_id" value="{{ report.id }}">
        {% endif %}

        <!-- Production ID (Auto-generated, Read-only) -->
        <div>
            <label for="production_id_display">Production ID <span class="auto-gen-label">(Auto-generated)</span> <span style="color: red;">*</span></label>
            <input type="text" id="production_id_display"
                value="{% if edit_mode %}{{ report.production_id }}{% else %}{{ next_production_id }}{% endif %}"
                readonly style="background-color: #f0f0f0; cursor: not-allowed; font-weight: 600; color: #4a5568;">
        </div>

        <!-- Date -->
        <div>
            <label for="date">Date</label>
            <input type="date" name="date" id="date"
                value="{% if edit_mode %}{{ report.date|date:'Y-m-d' }}{% endif %}">
        </div>

        <!-- Production Plan ID -->
        <div>
            <label for="production_plan_id">Production Plan ID</label>
            <select name="production_plan_id" id="production_plan_id">
                <option value="">Select Production Plan</option>
                {% for plan in production_plans %}
                <option value="{{ plan.id }}" {% if edit_mode and report.production_plan_id and report.production_plan_id.id == plan.id %}selected{% endif %}>
                    {{ plan.production_plan_id }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Customer Name (Auto-retrieve) -->
        <div>
            <label for="customer_name">Customer Name</label>
            <input type="text" name="customer_name" id="customer_name" readonly
                value="{% if edit_mode %}{{ report.customer_name }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Die Requisition ID (Auto-retrieve) -->
        <div>
            <label for="die_requisition_id">Die Requisition ID</label>
            <input type="text" name="die_requisition_id" id="die_requisition_id" readonly
                value="{% if edit_mode %}{{ report.die_requisition_id }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Die No (Auto-retrieve) -->
        <div>
            <label for="die_no">Die No</label>
            <input type="text" name="die_no" id="die_no" readonly
                value="{% if edit_mode %}{{ report.die_no }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Section No (Auto-retrieve) -->
        <div>
            <label for="section_no">Section No</label>
            <input type="text" name="section_no" id="section_no" readonly
                value="{% if edit_mode %}{{ report.section_no }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Section Name (Auto-retrieve) -->
        <div>
            <label for="section_name">Section Name</label>
            <input type="text" name="section_name" id="section_name" readonly
                value="{% if edit_mode %}{{ report.section_name }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- WT Per Piece (Auto-retrieve) -->
        <div>
            <label for="wt_per_piece">WT Per Piece</label>
            <input type="number" step="0.01" name="wt_per_piece" id="wt_per_piece" readonly
                value="{% if edit_mode and report.wt_per_piece %}{{ report.wt_per_piece }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Press (Auto-retrieve) -->
        <div>
            <label for="press_no">Press <span style="color: red;">*</span></label>
            <select name="press_no" id="press_no" required style="background-color: #f0f0f0;">
                <option value="">Select Press</option>
                {% for press in presses %}
                <option value="{{ press.id }}" {% if edit_mode and report.press_no.id == press.id %}selected{% endif %}>
                    {{ press.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Date of Production (Auto-retrieve) -->
        <div>
            <label for="date_of_production">Date of Production</label>
            <input type="date" name="date_of_production" id="date_of_production" readonly
                value="{% if edit_mode and report.date_of_production %}{{ report.date_of_production|date:'Y-m-d' }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Shift (Auto-retrieve) -->
        <div>
            <label for="shift">Shift</label>
            <select name="shift" id="shift" style="background-color: #f0f0f0;">
                <option value="">Select Shift</option>
                {% for s in shifts %}
                <option value="{{ s.id }}" {% if edit_mode and report.shift and report.shift.id == s.id %}selected{% endif %}>
                    {{ s.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Operator (Auto-retrieve) -->
        <div>
            <label for="operator">Operator</label>
            <select name="operator" id="operator" style="background-color: #f0f0f0;">
                <option value="">Select Operator</option>
                {% for s in staff %}
                <option value="{{ s.id }}" {% if edit_mode and report.operator and report.operator.id == s.id %}selected{% endif %}>
                    {{ s.first_name }} {{ s.last_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Planned QTY (Auto-retrieve) -->
        <div>
            <label for="planned_qty">Planned QTY</label>
            <input type="number" name="planned_qty" id="planned_qty" min="1" readonly
                value="{% if edit_mode and report.planned_qty %}{{ report.planned_qty }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Start Time -->
        <div>
            <label for="start_time">Start Time</label>
            <input type="time" name="start_time" id="start_time"
                value="{% if edit_mode and report.start_time %}{{ report.start_time|time:'H:i' }}{% endif %}">
        </div>

        <!-- End Time -->
        <div>
            <label for="end_time">End Time</label>
            <input type="time" name="end_time" id="end_time"
                value="{% if edit_mode and report.end_time %}{{ report.end_time|time:'H:i' }}{% endif %}">
        </div>

        <!-- Submit Button -->
        <button type="submit">
            {% if edit_mode %}Update Production Report{% else %}Save Production Report{% endif %}
        </button>
    </form>
</div>

<!-- Pass data to JavaScript -->
{% if edit_mode %}
<script>
    window.editMode = true;
    window.reportId = {{ report.id }};
    window.currentProductionId = "{{ report.production_id }}";
</script>
{% else %}
<script>
    window.editMode = false;
    window.nextProductionId = "{{ next_production_id }}";
    // Set today's date as default
    document.addEventListener('DOMContentLoaded', function() {
        const dateField = document.getElementById('date');
        if (dateField && !dateField.value) {
            const today = new Date().toISOString().split('T')[0];
            dateField.value = today;
        }
    });
</script>
{% endif %}

<!-- JavaScript -->
<script src="{% static 'js/online_production_report.js' %}"></script>

<style>
    .auto-gen-label {
        font-size: 0.75rem;
        color: #718096;
        font-style: italic;
        font-weight: normal;
    }
</style>

{% endblock %}