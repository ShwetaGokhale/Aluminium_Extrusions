{% extends "Master/Base/base.html" %}
{% block content %}
{% load static %}

<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'css/die_requisition.css' %}">

<!-- Popup Notification -->
<div id="popupMessage" class="popup-message hidden"></div>

<div class="form-container">
    <h3 class="text-2xl font-bold italic mb-4 text-center" style="color: #1e3a8a;">
        {% if edit_mode %}Edit Die Requisition{% else %}Die Requisition Form{% endif %}
    </h3>

    <form id="dieRequisitionForm" method="post"
        action="{% if edit_mode %}{% url 'die_requisition_edit' requisition.id %}{% else %}{% url 'die_requisition' %}{% endif %}">
        {% csrf_token %}

        {% if edit_mode %}
        <input type="hidden" name="requisition_id" value="{{ requisition.id }}">
        {% endif %}

        <!-- Die Requisition ID (Auto-generated, Read-only) -->
        <div>
            <label for="die_requisition_id_display">Die Requisition ID <span
                    class="auto-gen-label">(Auto-generated)</span></label>
            <input type="text" id="die_requisition_id_display"
                value="{% if edit_mode %}{{ requisition.die_requisition_id }}{% else %}{{ next_die_requisition_id }}{% endif %}"
                readonly style="background-color: #f0f0f0; cursor: not-allowed; font-weight: 600; color: #4a5568;">
        </div>

        <!-- Date (Non-editable) -->
        <div>
            <label for="date">Date</label>
            <input type="date" name="date" id="date" readonly
                value="{% if edit_mode %}{{ requisition.date|date:'Y-m-d' }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed; font-weight: 600; color: #4a5568;">
        </div>

        <!-- Press -->
        <div>
            <label for="press">Press <span style="color: red;">*</span></label>
            <select name="press" id="press" required>
                <option value="">Select Press</option>
                {% for p in presses %}
                <option value="{{ p.id }}" {% if edit_mode and requisition.press.id == p.id %}selected{% endif %}>
                    {{ p.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Shift -->
        <div>
            <label for="shift">Shift <span style="color: red;">*</span></label>
            <select name="shift" id="shift" required>
                <option value="">Select Shift</option>
                {% for s in shifts %}
                <option value="{{ s.id }}" {% if edit_mode and requisition.shift.id == s.id %}selected{% endif %}>
                    {{ s.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Staff Name -->
        <div>
            <label for="staff_name">Staff Name <span style="color: red;">*</span></label>
            <select name="staff_name" id="staff_name" required>
                <option value="">Select Staff</option>
                {% for st in staff %}
                <option value="{{ st.id }}" {% if edit_mode and requisition.staff_name.id == st.id %}selected{% endif %}>
                    {{ st.get_full_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Customer Requisition No -->
        <div>
            <label for="customer_requisition_no">Customer Requisition No <span style="color: red;">*</span></label>
            <select name="customer_requisition_no" id="customer_requisition_no" required>
                <option value="">Select Requisition</option>
                {% for req in requisitions %}
                <option value="{{ req.id }}" {% if edit_mode and requisition.customer_requisition_no.id == req.id %}selected{% endif %}>
                    {{ req.requisition_no }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Section No (Auto-retrieve) -->
        <div>
            <label for="section_no">Section No <span style="color: red;">*</span></label>
            <select name="section_no" id="section_no" required disabled>
                <option value="">Select Section</option>
            </select>
        </div>

        <!-- Section Name (Auto-retrieve) -->
        <div>
            <label for="section_name">Section Name</label>
            <input type="text" name="section_name" id="section_name" readonly
                value="{% if edit_mode %}{{ requisition.section_name }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- WT Range (Auto-retrieve, REQUIRED) -->
        <div>
            <label for="wt_range">WT Range <span style="color: red;">*</span></label>
            <input type="text" name="wt_range" id="wt_range" readonly required
                value="{% if edit_mode %}{{ requisition.wt_range }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Die No -->
        <div>
            <label for="die_no">Die No <span style="color: red;">*</span></label>
            <select name="die_no" id="die_no" required>
                <option value="">Select Die</option>
                {% for die in dies %}
                <option value="{{ die.id }}" {% if edit_mode and requisition.die_no.id == die.id %}selected{% endif %}>
                    {{ die.die_no }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Die Name (Auto-retrieve) -->
        <div>
            <label for="die_name">Die Name</label>
            <input type="text" name="die_name" id="die_name" readonly
                value="{% if edit_mode %}{{ requisition.die_name }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Present WT (Auto-retrieve) -->
        <div>
            <label for="present_wt">Present WT</label>
            <input type="number" step="0.01" name="present_wt" id="present_wt" readonly
                value="{% if edit_mode %}{{ requisition.present_wt }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- No of Cavity (Auto-retrieve) -->
        <div>
            <label for="no_of_cavity">No of Cavity</label>
            <input type="text" name="no_of_cavity" id="no_of_cavity" readonly
                value="{% if edit_mode %}{{ requisition.no_of_cavity }}{% endif %}"
                style="background-color: #f0f0f0; cursor: not-allowed;">
        </div>

        <!-- Cut Length (OPTIONAL - no red asterisk) -->
        <div>
            <label for="cut_length">Cut Length</label>
            <select name="cut_length" id="cut_length">
                <option value="">Select Cut Length</option>
                {% for value, display in cut_lengths %}
                    {% if edit_mode and requisition.cut_length == value %}
                        <option value="{{ value }}" selected>{{ display }}</option>
                    {% else %}
                        <option value="{{ value }}">{{ display }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- Remark -->
        <div class="full-width">
            <label for="remark">Remark</label>
            <textarea name="remark" id="remark" rows="3"
                placeholder="Enter remarks">{% if edit_mode %}{{ requisition.remark }}{% endif %}</textarea>
        </div>

        <!-- Submit Button -->
        <button type="submit">
            {% if edit_mode %}Update Die Requisition{% else %}Save Die Requisition{% endif %}
        </button>
    </form>
</div>

<!-- Pass data to JavaScript -->
{% if edit_mode %}
<script>
    window.editMode = true;
    window.requisitionId = {{ requisition.id }};
    window.currentDieRequisitionId = "{{ requisition.die_requisition_id }}";
</script>
{% else %}
<script>
    window.editMode = false;
    window.nextDieRequisitionId = "{{ next_die_requisition_id }}";
</script>
{% endif %}

<!-- JavaScript -->
<script src="{% static 'js/die_requisition.js' %}"></script>

<style>
    .auto-gen-label {
        font-size: 0.75rem;
        color: #718096;
        font-style: italic;
        font-weight: normal;
    }
</style>

{% endblock %}