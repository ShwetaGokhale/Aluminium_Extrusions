{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Extruedge Login</title>
    <link rel="stylesheet" href="{% static 'css/login_style.css' %}">
    <style>
        .loader {
            border: 2px solid #f3f3f3; /* Light grey */
            border-top: 2px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

    </style>
</head>
<body>
    
    <div class="form-container">
        <div class="form-box">

            {% if request.user.is_authenticated and request.user.user_type == 1 %}
            <!-- Only superuser sees this -->
            <button id="registerIconBtn" onclick="openEmailPopup()">
                <img id="registerIcon" src="{% static 'images/add_user.png' %}" alt="Add User" />
            </button>
            {% endif %}

            <img src="{% static 'images/panache alu logo 2.avif' %}" alt="panache logo" style="display: block; margin: 0 auto 10px auto; max-width: 150px;">

            <h2>Login</h2>

            {% if error %}
                <div class="error-box">{{ error }}</div>
            {% endif %}

            <form id="login-form">
                {% csrf_token %}

                <!-- Email Input -->
                <label for="id_email">Email</label>
                <input type="email" id="id_email" name="email" class="form-control" placeholder="Enter your email" required />

                <div id="verify-message" style="color: green; margin-top: 10px;"></div>

                <!-- OTP Section -->
                <div id="otp-field" style="display: none; margin-top: 16px;">
                    <label>Enter OTP</label>
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        {% for i in "123456" %}
                        <input type="text" maxlength="1" class="otp-box" style="width: 40px; height: 40px; text-align: center;" />
                        {% endfor %}
                    </div>
                    <div id="otp-timer" style="margin-top: 10px; font-size: 14px;"></div>
                    <input type="hidden" name="otp" id="id_otp" />
                </div>

                <!-- Login Button -->
                <button type="submit" class="login-btn" id="login-btn">
                    <span id="btn-text">Login</span>
                    <span id="btn-loader" class="loader" style="display: none;"></span>
                </button>
            </form>
            
            <p class="form-footer">
                Made with care by <strong>Infimetrics Info Solutions Pvt. Ltd</strong>
            </p>
        </div>
    </div>

    <!-- Email Verification Popup for Superuser -->
    <div id="emailPopup" style="display: none;">
        <div id="emailPopupContent">
            <button class="close-btn" onclick="closeEmailPopup()">âœ•</button>
            <h3>Verify Email to Register</h3>
            <p>Enter your email to continue:</p>
            <input type="email" id="emailInput" placeholder="example@example.com" />
            <div id="emailMessage" style="margin-top: 10px;"></div>
            <button onclick="verifyEmail()">Submit</button>
        </div>
    </div>

    <!-- Global Config (Dynamic-values-from-Django) -->
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        window.APP_CONFIG = {
            SEND_OTP_URL: "{% url 'send-otp' %}",
            VERIFY_OTP_URL: "{% url 'verify-otp' %}",
            REGISTER_URL: "{% url 'create-user' %}",
            LOGIN_URL: "{% url 'login' %}", 
            DASHBOARD_URL: "{% url 'dashboard' %}",
            CSRF_TOKEN: getCookie('csrftoken')
        };
    </script>

    <!-- Load JS (correct path) -->
    <script src="{% static 'js/login_script.js' %}"></script>

</body>
</html>
